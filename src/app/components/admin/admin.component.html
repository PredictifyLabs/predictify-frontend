<div class="admin-layout">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="assets/images/Logo.png" alt="Predictify Logo" class="logo-icon">
        <div class="logo-text-container">
          <span class="logo-title">Predictify</span>
          <span class="logo-subtitle">AI-POWERED ATTENDANCE FORECASTING!</span>
        </div>
      </div>
      <span class="admin-badge">ADMIN</span>
    </div>

    <nav class="sidebar-nav">
      <ul>
        <li>
          <a [class.active]="currentSection === 'dashboard'" (click)="setSection('dashboard')">
            <span nz-icon nzType="dashboard" nzTheme="outline"></span>
            <span class="nav-label">Dashboard</span>
          </a>
        </li>
        <li>
          <a [class.active]="currentSection === 'users'" (click)="setSection('users')">
            <span nz-icon nzType="team" nzTheme="outline"></span>
            <span class="nav-label">Usuarios</span>
          </a>
        </li>
        <li>
          <a [class.active]="currentSection === 'events'" (click)="setSection('events')">
            <span nz-icon nzType="calendar" nzTheme="outline"></span>
            <span class="nav-label">Eventos</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="sidebar-footer">
      <button class="logout-btn" (click)="logout()">
        <span nz-icon nzType="logout" nzTheme="outline"></span>
        Cerrar Sesión
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Top Bar -->
    <header class="admin-header">
      <div class="header-left">
        <h2>{{ getHeaderTitle() }}</h2>
      </div>
      <div class="header-right">
        <div class="admin-profile">
          <span nz-icon nzType="user" nzTheme="outline"></span>
          <span class="admin-name">Administrador</span>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="admin-content">
      
      <!-- ==================== DASHBOARD ==================== -->
      <div *ngIf="currentSection === 'dashboard'" class="dashboard-section">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon blue">
              <span nz-icon nzType="calendar" nzTheme="outline"></span>
            </div>
            <div class="kpi-info">
              <span class="kpi-number">{{ stats.totalEvents }}</span>
              <span class="kpi-label">Total Eventos</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon green">
              <span nz-icon nzType="team" nzTheme="outline"></span>
            </div>
            <div class="kpi-info">
              <span class="kpi-number">{{ stats.totalUsers }}</span>
              <span class="kpi-label">Total Usuarios</span>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-icon purple">
              <span nz-icon nzType="crown" nzTheme="outline"></span>
            </div>
            <div class="kpi-info">
              <span class="kpi-number">{{ stats.totalOrganizers }}</span>
              <span class="kpi-label">Total Organizadores</span>
            </div>
          </div>
        </div>

        <!-- Prediction Stats -->
        <div class="prediction-section">
          <h3><span nz-icon nzType="bar-chart" nzTheme="outline"></span> Predicciones de Asistencia IA</h3>
          <div class="prediction-grid">
            <div class="prediction-card">
              <div class="prediction-header">
                <span class="prediction-title">Precisión del Modelo</span>
                <span class="prediction-badge success">Activo</span>
              </div>
              <div class="prediction-value">87.3%</div>
              <div class="prediction-bar">
                <div class="prediction-fill" style="width: 87.3%"></div>
              </div>
              <span class="prediction-detail">Basado en 2,847 predicciones</span>
            </div>

            <div class="prediction-card">
              <div class="prediction-header">
                <span class="prediction-title">Predicciones Hoy</span>
              </div>
              <div class="prediction-value">1,247</div>
              <span class="prediction-detail">+12% vs. ayer</span>
            </div>

            <div class="prediction-card">
              <div class="prediction-header">
                <span class="prediction-title">Asistencia Promedio</span>
              </div>
              <div class="prediction-value">78%</div>
              <span class="prediction-detail">De capacidad total</span>
            </div>
          </div>
        </div>

        <!-- Top Events by Prediction -->
        <div class="top-events-section">
          <h3><span nz-icon nzType="aim" nzTheme="outline"></span> Top Eventos por Predicción</h3>
          <div class="top-events-list">
            <div class="top-event-item" *ngFor="let ev of topEventsByPrediction; let i = index">
              <span class="top-event-rank">{{ i + 1 }}</span>
              <div class="top-event-info">
                <span class="top-event-title">{{ ev.title }}</span>
                <span class="top-event-category">{{ ev.category }}</span>
              </div>
              <div class="top-event-stats">
                <span class="top-event-registered">{{ ev.registered || 0 }}/{{ ev.capacity }}</span>
                <div class="top-event-prediction" [class.high]="(ev.prediction || 0) >= 80" [class.medium]="(ev.prediction || 0) >= 50 && (ev.prediction || 0) < 80" [class.low]="(ev.prediction || 0) < 50">
                  {{ ev.prediction || 0 }}%
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard-actions">
          <button class="action-card" (click)="setSection('users')">
            <span nz-icon nzType="user-add" nzTheme="outline"></span>
            <span>Gestionar Usuarios</span>
          </button>
          <button class="action-card" (click)="setSection('events')">
            <span nz-icon nzType="plus-circle" nzTheme="outline"></span>
            <span>Gestionar Eventos</span>
          </button>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
          <div class="charts-grid">
            <!-- Users Activity Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h4><span nz-icon nzType="rise" nzTheme="outline"></span> Usuarios Activos (Últimos 7 días)</h4>
              </div>
              <div class="chart-body">
                <div class="bar-chart">
                  <div class="bar-item" *ngFor="let day of chartData.usersActivity">
                    <div class="bar" [style.height.%]="day.value"></div>
                    <span class="bar-label">{{ day.label }}</span>
                    <span class="bar-value">{{ day.value }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Events by Category Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h4><span nz-icon nzType="pie-chart" nzTheme="outline"></span> Eventos por Categoría</h4>
              </div>
              <div class="chart-body">
                <div class="donut-chart-container">
                  <div class="donut-chart">
                    <div class="donut-segment" *ngFor="let cat of chartData.eventsByCategory; let i = index"
                      [style.--offset]="getDonutOffset(i)"
                      [style.--value]="cat.percentage"
                      [style.--color]="cat.color">
                    </div>
                    <div class="donut-center">
                      <span class="donut-total">{{ stats.totalEvents }}</span>
                      <span class="donut-label">Eventos</span>
                    </div>
                  </div>
                  <div class="chart-legend">
                    <div class="legend-item" *ngFor="let cat of chartData.eventsByCategory">
                      <span class="legend-color" [style.background]="cat.color"></span>
                      <span class="legend-label">{{ cat.label }}</span>
                      <span class="legend-value">{{ cat.count }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Registrations Trend -->
            <div class="chart-card wide">
              <div class="chart-header">
                <h4><span nz-icon nzType="line-chart" nzTheme="outline"></span> Inscripciones Mensuales</h4>
              </div>
              <div class="chart-body">
                <div class="line-chart">
                  <div class="line-chart-grid">
                    <div class="grid-line" *ngFor="let line of [100, 75, 50, 25, 0]">
                      <span class="grid-label">{{ line }}</span>
                    </div>
                  </div>
                  <div class="line-chart-bars">
                    <div class="line-bar" *ngFor="let month of chartData.registrationsTrend">
                      <div class="line-bar-fill" [style.height.%]="month.value"></div>
                      <span class="line-bar-label">{{ month.label }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== USUARIOS ==================== -->
      <div *ngIf="currentSection === 'users'" class="users-section">
        <div class="section-header">
          <h3>Gestión de Usuarios</h3>
          <button class="btn-primary" (click)="openCreateUserModal()">
            <span nz-icon nzType="user-add" nzTheme="outline"></span>
            Nuevo Usuario
          </button>
        </div>

        <div class="filters-bar">
          <input type="text" placeholder="Buscar por nombre, email..." class="search-input" [(ngModel)]="userSearch">
          <select class="filter-select" [(ngModel)]="userRoleFilter">
            <option value="">Todos los Roles</option>
            <option value="ATTENDEE">Usuario</option>
            <option value="ORGANIZER">Organizador</option>
            <option value="ADMIN">Admin</option>
          </select>
          <select class="filter-select" [(ngModel)]="userStatusFilter">
            <option value="">Todos los Estados</option>
            <option value="ACTIVE">Activo</option>
            <option value="BLOCKED">Bloqueado</option>
            <option value="BANNED">Baneado</option>
          </select>
        </div>

        <div class="data-table">
          <div class="table-header">
            <span>Usuario</span>
            <span>Email</span>
            <span>Rol</span>
            <span>Estado</span>
            <span>Acciones</span>
          </div>
          <div class="table-row" *ngFor="let u of filteredUsers">
            <span class="user-cell">
              <img [src]="'https://api.dicebear.com/7.x/initials/svg?seed=' + u.name" alt="">
              {{ u.name }}
            </span>
            <span>{{ u.email }}</span>
            <span>
              <span class="role-badge" [class.organizer]="u.role === 'ORGANIZER'" [class.admin]="u.role === 'ADMIN'">
                {{ u.role }}
              </span>
            </span>
            <span>
              <span class="status-badge" [class.active]="u.status === 'ACTIVE'" [class.blocked]="u.status === 'BLOCKED'" [class.banned]="u.status === 'BANNED'">
                {{ u.status }}
              </span>
            </span>
            <span class="actions">
              <button class="icon-btn edit" title="Editar" (click)="openEditUserModal(u)">
                <span nz-icon nzType="edit" nzTheme="outline"></span>
              </button>
              <button class="icon-btn key" title="Cambiar Contraseña" (click)="openChangePasswordModal(u)">
                <span nz-icon nzType="key" nzTheme="outline"></span>
              </button>
              <button class="icon-btn" [class.ban]="u.status !== 'BANNED'" [class.unban]="u.status === 'BANNED'" title="Banear/Desbanear" (click)="toggleBanUserDirect(u)">
                <span nz-icon nzType="stop" nzTheme="outline"></span>
              </button>
              <button class="icon-btn delete" title="Eliminar" (click)="deleteUserDirect(u)">
                <span nz-icon nzType="delete" nzTheme="outline"></span>
              </button>
            </span>
          </div>
          <div class="empty-state" *ngIf="filteredUsers.length === 0">
            <span nz-icon nzType="inbox" nzTheme="outline"></span>
            <p>No se encontraron usuarios</p>
          </div>
        </div>
      </div>

      <!-- ==================== EVENTOS ==================== -->
      <div *ngIf="currentSection === 'events'" class="events-section">
        <div class="section-header">
          <h3>Gestión de Eventos</h3>
          <button class="btn-primary" (click)="openCreateEventModal()">
            <span nz-icon nzType="plus" nzTheme="outline"></span>
            Nuevo Evento
          </button>
        </div>

        <div class="filters-bar">
          <input type="text" placeholder="Buscar eventos..." class="search-input" [(ngModel)]="eventSearch">
          <select class="filter-select" [(ngModel)]="eventStatusFilter">
            <option value="">Todos los Estados</option>
            <option value="DRAFT">Borrador</option>
            <option value="PUBLISHED">Publicado</option>
            <option value="CANCELLED">Cancelado</option>
            <option value="COMPLETED">Completado</option>
          </select>
        </div>

        <div class="data-table events-table">
          <div class="table-header">
            <span>Evento</span>
            <span>Categoría</span>
            <span>Organizador</span>
            <span>Registrados</span>
            <span>Predicción</span>
            <span>Estado</span>
            <span>Acciones</span>
          </div>
          <div class="table-row" *ngFor="let ev of filteredEvents">
            <span class="event-title">{{ ev.title }}</span>
            <span>
              <span class="category-badge">{{ ev.category || 'N/A' }}</span>
            </span>
            <span>{{ ev.organizerName }}</span>
            <span>{{ ev.registered || 0 }}/{{ ev.capacity }}</span>
            <span>
              <span class="prediction-badge" [class.high]="(ev.prediction || 0) >= 80" [class.medium]="(ev.prediction || 0) >= 50 && (ev.prediction || 0) < 80" [class.low]="(ev.prediction || 0) < 50">
                {{ ev.prediction || 0 }}%
              </span>
            </span>
            <span>
              <span class="status-badge" [class.draft]="ev.status === 'DRAFT'" [class.published]="ev.status === 'PUBLISHED'" [class.cancelled]="ev.status === 'CANCELLED'">
                {{ ev.status }}
              </span>
            </span>
            <span class="actions">
              <button class="icon-btn edit" title="Editar" (click)="openEditEventModal(ev)">
                <span nz-icon nzType="edit" nzTheme="outline"></span>
              </button>
              <button class="icon-btn delete" title="Eliminar" (click)="deleteEvent(ev)">
                <span nz-icon nzType="delete" nzTheme="outline"></span>
              </button>
            </span>
          </div>
          <div class="empty-state" *ngIf="filteredEvents.length === 0">
            <span nz-icon nzType="inbox" nzTheme="outline"></span>
            <p>No se encontraron eventos</p>
          </div>
        </div>
      </div>

      <!-- ==================== MODALES ==================== -->
      
      <!-- Create/Edit User Modal -->
      <div *ngIf="isCreateUserModalOpen" class="modal-backdrop" (click)="closeCreateUserModal()"></div>
      <div *ngIf="isCreateUserModalOpen" class="modal">
        <div class="modal-header">
          <h3>{{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
          <button class="close-btn" (click)="closeCreateUserModal()">
            <span nz-icon nzType="close" nzTheme="outline"></span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="createUserForm.name" placeholder="Nombre completo">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" [(ngModel)]="createUserForm.email" placeholder="correo@ejemplo.com">
          </div>
          <div class="form-group">
            <label>Rol</label>
            <select [(ngModel)]="createUserForm.role">
              <option value="ATTENDEE">Usuario</option>
              <option value="ORGANIZER">Organizador</option>
              <option value="ADMIN">Administrador</option>
            </select>
          </div>
          <div class="form-group" *ngIf="!editingUser">
            <label>Contraseña</label>
            <input type="text" [(ngModel)]="createUserForm.password" placeholder="Contraseña">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeCreateUserModal()">Cancelar</button>
          <button class="btn-primary" (click)="saveUser()">{{ editingUser ? 'Guardar' : 'Crear' }}</button>
        </div>
      </div>

      <!-- Create/Edit Event Modal -->
      <div *ngIf="isCreateEventModalOpen" class="modal-backdrop" (click)="closeCreateEventModal()"></div>
      <div *ngIf="isCreateEventModalOpen" class="modal modal-lg">
        <div class="modal-header">
          <h3>{{ editingEvent ? 'Editar Evento' : 'Nuevo Evento' }}</h3>
          <button class="close-btn" (click)="closeCreateEventModal()">
            <span nz-icon nzType="close" nzTheme="outline"></span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Título</label>
              <input type="text" [(ngModel)]="createEventForm.title" placeholder="Nombre del evento">
            </div>
            <div class="form-group">
              <label>Organizador</label>
              <select [(ngModel)]="createEventForm.organizerName">
                <option value="">Seleccionar organizador...</option>
                <option *ngFor="let org of organizers" [value]="org.name">{{ org.name }}</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Descripción</label>
            <textarea [(ngModel)]="createEventForm.description" rows="3" placeholder="Descripción del evento"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Categoría</label>
              <select [(ngModel)]="createEventForm.category">
                <option value="CONFERENCE">Conferencia</option>
                <option value="WORKSHOP">Workshop</option>
                <option value="MEETUP">Meetup</option>
                <option value="HACKATHON">Hackathon</option>
                <option value="WEBINAR">Webinar</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <select [(ngModel)]="createEventForm.type">
                <option value="PRESENCIAL">Presencial</option>
                <option value="VIRTUAL">Virtual</option>
                <option value="HIBRIDO">Híbrido</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Fecha</label>
              <input type="date" [(ngModel)]="createEventForm.startDate">
            </div>
            <div class="form-group">
              <label>Hora</label>
              <input type="time" [(ngModel)]="createEventForm.startTime">
            </div>
            <div class="form-group">
              <label>Capacidad</label>
              <input type="number" [(ngModel)]="createEventForm.capacity" min="1">
            </div>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select [(ngModel)]="createEventForm.status">
              <option value="DRAFT">Borrador</option>
              <option value="PUBLISHED">Publicado</option>
            </select>
          </div>

          <!-- Approval Toggle -->
          <div class="form-group toggle-group">
            <div class="toggle-container">
              <label class="toggle-label">
                <span nz-icon nzType="safety-certificate" nzTheme="outline"></span>
                ¿Requiere Aprobación?
              </label>
              <p class="toggle-description">Si está activado, los asistentes deberán ser aprobados antes de confirmar su inscripción.</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" [(ngModel)]="createEventForm.requiresApproval">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <!-- Location Section -->
          <div class="location-section">
            <h4><span nz-icon nzType="environment" nzTheme="outline"></span> Ubicación del Evento</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Dirección</label>
                <input type="text" [(ngModel)]="createEventForm.address" placeholder="Ej: Carrera 7 #32-16">
              </div>
              <div class="form-group">
                <label>Ciudad</label>
                <input type="text" [(ngModel)]="createEventForm.city" placeholder="Ej: Bogotá">
              </div>
            </div>
            <div class="form-group">
              <label>Lugar / Venue</label>
              <input type="text" [(ngModel)]="createEventForm.venue" placeholder="Ej: Centro de Convenciones">
            </div>
            
            <div class="map-toggle">
              <button type="button" class="btn-map" (click)="toggleMapPicker()">
                <span nz-icon nzType="environment" nzTheme="outline"></span>
                {{ showMapPicker ? 'Ocultar Mapa' : 'Seleccionar en Mapa' }}
              </button>
              <span class="coordinates" *ngIf="createEventForm.latitude && createEventForm.longitude">
                Lat: {{ createEventForm.latitude.toFixed(4) }}, Lng: {{ createEventForm.longitude.toFixed(4) }}
              </span>
            </div>
            
            <div class="map-container" *ngIf="showMapPicker">
              <iframe 
                [src]="'https://www.openstreetmap.org/export/embed.html?bbox=' + (createEventForm.longitude - 0.01) + ',' + (createEventForm.latitude - 0.01) + ',' + (createEventForm.longitude + 0.01) + ',' + (createEventForm.latitude + 0.01) + '&layer=mapnik&marker=' + createEventForm.latitude + ',' + createEventForm.longitude | safe"
                width="100%" 
                height="250" 
                frameborder="0" 
                style="border-radius: 12px;">
              </iframe>
              <p class="map-hint">Ingresa las coordenadas manualmente o busca la dirección en Google Maps</p>
              <div class="form-row">
                <div class="form-group">
                  <label>Latitud</label>
                  <input type="number" [(ngModel)]="createEventForm.latitude" step="0.0001">
                </div>
                <div class="form-group">
                  <label>Longitud</label>
                  <input type="number" [(ngModel)]="createEventForm.longitude" step="0.0001">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeCreateEventModal()">Cancelar</button>
          <button class="btn-primary" (click)="saveEvent()">{{ editingEvent ? 'Guardar' : 'Crear' }}</button>
        </div>
      </div>

      <!-- Password Change Modal -->
      <div class="modal-overlay" *ngIf="isPasswordModalOpen" (click)="closePasswordModal()">
        <div class="modal-content small" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h3><span nz-icon nzType="lock" nzTheme="outline"></span> Cambiar Contraseña</h3>
            <button class="modal-close" (click)="closePasswordModal()">
              <span nz-icon nzType="close" nzTheme="outline"></span>
            </button>
          </div>
          <div class="modal-body">
            <p class="password-user-info">
              Cambiar contraseña para: <strong>{{ passwordChangeUser?.name }}</strong>
            </p>
            <div class="form-group">
              <label>Nueva Contraseña</label>
              <input type="password" [(ngModel)]="newPassword" placeholder="Ingresa la nueva contraseña" minlength="6">
            </div>
            <div class="form-group">
              <label>Confirmar Contraseña</label>
              <input type="password" [(ngModel)]="confirmPassword" placeholder="Confirma la nueva contraseña">
            </div>
            <p class="password-hint" *ngIf="newPassword && confirmPassword && newPassword !== confirmPassword">
              <span nz-icon nzType="warning" nzTheme="outline"></span>
              Las contraseñas no coinciden
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" (click)="closePasswordModal()">Cancelar</button>
            <button class="btn-primary" (click)="savePassword()" [disabled]="!newPassword || newPassword !== confirmPassword">
              Guardar Contraseña
            </button>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

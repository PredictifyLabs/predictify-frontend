@if (event(); as ev) {
<div class="event-detail-page">
  
  <!-- Hero Section -->
  <div class="event-hero" [style.background-image]="'linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.8)), url(' + ev.imageUrl + ')'">
    <div class="hero-content">
      <!-- Breadcrumbs -->
      <div class="breadcrumbs">
        <span class="breadcrumb-item" (click)="goBack()">
          <span nz-icon nzType="arrow-left" nzTheme="outline"></span> Eventos
        </span>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">{{ ev.title }}</span>
      </div>

      <!-- Tags -->
      <div class="event-tags">
        <span class="tag category">{{ ev.category }}</span>
        <span class="tag type">{{ ev.location.type }}</span>
        @if (ev.isTrending) {
          <span class="tag trending"><span nz-icon nzType="fire" nzTheme="fill"></span> Trending</span>
        }
      </div>

      <!-- Title -->
      <h1 class="event-title">{{ ev.title }}</h1>

      <!-- Organizer -->
      <div class="organizer-info">
        <img [src]="ev.organizer.avatar" [alt]="ev.organizer.displayName" class="organizer-avatar">
        <div class="organizer-details">
          <span class="organizer-name">
            {{ ev.organizer.displayName }}
            @if (ev.organizer.isVerified) {
              <span nz-icon nzType="safety-certificate" nzTheme="fill" class="verified-icon"></span>
            }
          </span>
          <span class="organizer-meta">{{ ev.organizer.eventsCount }} eventos organizados</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="hero-actions">
        <button class="action-btn" (click)="share()">
          <span nz-icon nzType="share-alt" nzTheme="outline"></span>
          Compartir
        </button>
        <button class="action-btn" [class.saved]="isSaved()" (click)="toggleSave()">
          <span nz-icon nzType="heart" [nzTheme]="isSaved() ? 'fill' : 'outline'"></span>
          {{ isSaved() ? 'Guardado' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="event-content">
    <div class="content-grid">
      
      <!-- Left Column -->
      <div class="left-column">
        
        <!-- Prediction Panel -->
        @if (prediction(); as pred) {
        <div class="prediction-panel card-glass">
          <div class="panel-header">
            <h2><span nz-icon nzType="robot" nzTheme="outline"></span> Predicción IA de Asistencia</h2>
          </div>
          
          <div class="prediction-content">
            <div class="prediction-info">
              <div class="prediction-level" [class]="pred.level">
                <span class="level-icon">
                  <span nz-icon [nzType]="pred.level === 'HIGH' ? 'check-circle' : pred.level === 'MEDIUM' ? 'info-circle' : 'close-circle'" nzTheme="fill"></span>
                </span>
                <span class="level-text">
                  @if (pred.level === 'HIGH') { Alta probabilidad de asistencia }
                  @else if (pred.level === 'MEDIUM') { Probabilidad media de asistencia }
                  @else { Baja probabilidad de asistencia }
                </span>
              </div>

              <div class="estimation">
                <h4>Estimación de asistentes:</h4>
                <p class="estimation-range">
                  {{ pred.estimatedMin }}-{{ pred.estimatedMax }} personas
                  <span class="expected">(~{{ pred.estimatedExpected }} esperados)</span>
                </p>
                <p class="capacity-info">de {{ ev.capacity }} capacidad total</p>
              </div>

              <button class="btn-secondary full-width">
                Ver Análisis Completo
              </button>
            </div>
          </div>
        </div>
        }

        <!-- Description -->
        <div class="description-section card-glass">
          <h3><span nz-icon nzType="file-text" nzTheme="outline"></span> Descripción del Evento</h3>
          <p class="description-text">{{ ev.description }}</p>
        </div>

        <!-- Location -->
        <div class="location-section card-glass">
          <h3><span nz-icon nzType="environment" nzTheme="outline"></span> Ubicación</h3>
          <div class="location-info">
            <p class="location-type">
              <span nz-icon [nzType]="ev.location.type === 'VIRTUAL' ? 'global' : 'environment'" nzTheme="outline"></span>
              {{ ev.location.type === 'VIRTUAL' ? 'Evento Virtual' : 'Evento Presencial' }}
            </p>
            @if (ev.location.address) {
              <p class="location-address">
                {{ ev.location.address }}, {{ ev.location.city }}, {{ ev.location.country }}
              </p>
            }
            @if (ev.location.venue) {
              <p class="location-venue">{{ ev.location.venue }}</p>
            }
          </div>
          
          <!-- OpenStreetMap Embed -->
          @if (ev.location.latitude && ev.location.longitude && ev.location.type !== 'VIRTUAL') {
            <div class="location-map">
              <iframe 
                class="osm-iframe"
                [src]="getMapUrl(ev.location.latitude, ev.location.longitude)"
                width="100%"
                height="250"
                frameborder="0"
                scrolling="no"
                loading="lazy"
                allowfullscreen>
              </iframe>
              <div class="map-actions">
                <a [href]="'https://www.google.com/maps?q=' + ev.location.latitude + ',' + ev.location.longitude" 
                   target="_blank" 
                   class="map-link-btn">
                  <span nz-icon nzType="environment" nzTheme="outline"></span>
                  Abrir en Google Maps
                </a>
                <span class="map-coordinates">
                  <span nz-icon nzType="aim" nzTheme="outline"></span>
                  {{ ev.location.latitude }}, {{ ev.location.longitude }}
                </span>
              </div>
            </div>
          }
        </div>

      </div>

      <!-- Right Column - Sticky -->
      <div class="right-column">
        <div class="sticky-sidebar">
          
          <!-- Calendar Card -->
          <div class="calendar-card card-glass">
            <div class="calendar-hero" [style.background-image]="'linear-gradient(180deg, rgba(10,10,10,0.15) 0%, rgba(10,10,10,0.85) 100%), url(' + ev.imageUrl + ')'">
              <div class="calendar-hero-top">
                <div class="calendar-hero-date">
                  <div class="calendar-hero-day">{{ getCalendarDay(ev.startDate) }}</div>
                  <div class="calendar-hero-weekday">{{ ev.startDate | date:'EEEE' }}</div>
                </div>
                <div class="calendar-hero-month">
                  <div class="calendar-hero-month-name">{{ getCalendarMonthLabel(ev.startDate) }}</div>
                  <div class="calendar-hero-year">{{ getCalendarYear(ev.startDate) }}</div>
                </div>
              </div>

              <div class="calendar-hero-time">
                <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
                <span>{{ ev.startTime }} - {{ ev.endTime || 'TBD' }}</span>
              </div>
            </div>

            <div class="calendar-grid">
              <div class="calendar-weekdays">
                @for (wd of calendarWeekdays; track wd) {
                  <div class="calendar-weekday-cell">{{ wd }}</div>
                }
              </div>

              <div class="calendar-weeks">
                @for (week of getCalendarWeeks(ev.startDate); track $index) {
                  <div class="calendar-week-row">
                    @for (day of week; track $index) {
                      @if (day === null) {
                        <div class="calendar-day-cell is-empty"></div>
                      } @else {
                        <div
                          class="calendar-day-cell"
                          [class.is-event-day]="day === getCalendarDay(ev.startDate)"
                          [class.is-weekend]="$index === 5 || $index === 6"
                        >
                          {{ day }}
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            </div>
          </div>

          <!-- Event Info Card -->
          <div class="info-card card-glass">
            <div class="info-item">
              <span nz-icon nzType="calendar" nzTheme="outline"></span>
              <div class="info-text">
                <span class="info-label">Fecha</span>
                <span class="info-value">{{ formatDate(ev.startDate) }}</span>
              </div>
            </div>

            <div class="info-item">
              <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
              <div class="info-text">
                <span class="info-label">Hora</span>
                <span class="info-value">{{ ev.startTime }}</span>
              </div>
            </div>

            <div class="info-item">
              <span nz-icon nzType="environment" nzTheme="outline"></span>
              <div class="info-text">
                <span class="info-label">Ubicación</span>
                <span class="info-value">{{ ev.location.city || 'Virtual' }}</span>
              </div>
            </div>

            <div class="info-item">
              <span nz-icon nzType="dollar" nzTheme="outline"></span>
              <div class="info-text">
                <span class="info-label">Precio</span>
                <span class="info-value">{{ ev.isFree ? 'Gratis' : '$' + ev.price }}</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="capacity-info-box">
              <div class="capacity-item">
                <span class="capacity-number">{{ ev.interestedCount }}</span>
                <span class="capacity-label">Interesados</span>
              </div>
              <div class="capacity-item">
                <span class="capacity-number">{{ ev.capacity }}</span>
                <span class="capacity-label">Capacidad</span>
              </div>
            </div>

            <button class="btn-primary full-width" (click)="register()">
              Registrarse Ahora
            </button>

            <div class="divider"></div>

            <!-- Share -->
            <div class="share-section">
              <span class="share-label">Compartir:</span>
              <div class="share-buttons">
                <button class="share-btn" (click)="showQRModal()"><span nz-icon nzType="qrcode" nzTheme="outline"></span></button>
                <button class="share-btn"><span nz-icon nzType="twitter" nzTheme="outline"></span></button>
                <button class="share-btn"><span nz-icon nzType="mail" nzTheme="outline"></span></button>
                <button class="share-btn" (click)="share()"><span nz-icon nzType="link" nzTheme="outline"></span></button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

</div>
} @else {
<!-- Loading State -->
<div class="loading-container">
  <div class="loading-logo-wrapper">
    <img src="assets/images/Logo.png" alt="Predictify" class="loading-logo" />
    <div class="loading-spinner"></div>
  </div>
  <p>Cargando evento...</p>
</div>
}
